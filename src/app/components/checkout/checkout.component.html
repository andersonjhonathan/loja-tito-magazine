<div class="container my-5">
    <div class="row">
        <!-- Coluna Esquerda: Formul√°rio -->
        <div class="col-md-7">
            <div class="mb-4 text-center">
                <img src="assets/tito_logo.png" alt="Logo Soft" width="150" class="rounded" />
            </div>

            <!-- Contato -->
            <h5 class="text-uppercase text-primary mb-4">Contato</h5>
            <form #checkoutForm="ngForm" (ngSubmit)="finalizarCompra(checkoutForm)">
                <div class="mb-3">
                    <input type="email" class="form-control rounded-3 shadow-sm" placeholder="E-mail*" required
                        name="email" [(ngModel)]="cliente.email" #email="ngModel" />
                    <div *ngIf="email.invalid && email.touched" class="text-danger small">
                        Informe um email v√°lido.
                    </div>
                </div>
                <div class="mb-3">
                    <input type="text" class="form-control rounded-3 shadow-sm" placeholder="Nome completo*" required
                        name="nome" [(ngModel)]="cliente.nome" #nome="ngModel" />
                    <div *ngIf="nome.invalid && nome.touched" class="text-danger small">
                        Informe seu nome completo.
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <input type="text" class="form-control rounded-3 shadow-sm" placeholder="Celular*" required
                            name="celular" [(ngModel)]="cliente.celular" #celular="ngModel" />
                        <div *ngIf="celular.invalid && celular.touched" class="text-danger small">
                            Informe seu celular.
                        </div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <input type="text" class="form-control rounded-3 shadow-sm" placeholder="CPF*" required
                            name="cpf" [(ngModel)]="cliente.cpf" #cpf="ngModel" />
                        <div *ngIf="cpf.invalid && cpf.touched" class="text-danger small">
                            Informe seu CPF.
                        </div>
                    </div>
                </div>

                <!-- Endere√ßo -->
                <div class="mb-3">
                    <label for="cep" class="form-label">CEP*</label>
                    <input type="text" id="cep" class="form-control" placeholder="Digite seu CEP" required name="cep"
                        [(ngModel)]="cep" (blur)="buscarEnderecoPorCep()" #cepModel="ngModel" />
                    <div *ngIf="cepModel.invalid && cepModel.touched" class="text-danger small">
                        Informe um CEP v√°lido.
                    </div>
                </div>

                <!-- ERRO -->
                <div *ngIf="mensagemErroCep" class="alert alert-danger">
                    {{ mensagemErroCep }}
                </div>

                <!-- BLOCO DE ENTREGA SOMENTE SE CEP FOI ENCONTRADO -->
                <div *ngIf="exibirEntrega">
                    <p><strong>{{ cep }}</strong> - {{ endereco.cidade }}/{{ endereco.estado }}</p>

                    <div class="mb-3">
                        <label class="form-label">Endere√ßo*</label>
                        <input class="form-control" [value]="endereco.rua" readonly />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">N√∫mero*</label>
                        <input class="form-control" required name="numero" [(ngModel)]="endereco.numero"
                            #numero="ngModel" />
                        <div *ngIf="numero.invalid && numero.touched" class="text-danger small">
                            Informe o n√∫mero.
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Bairro*</label>
                        <input class="form-control" [value]="endereco.bairro" readonly />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Complemento</label>
                        <input class="form-control" name="complemento" [(ngModel)]="endereco.complemento" />
                    </div>

                    <!-- M√©todo de envio -->
                    <h5>M√©todo de envio</h5>
                    <div class="border p-3 rounded bg-light">
                        <div class="d-flex justify-content-between">
                            <label for="freteGratis" class="form-check-label">
                                <input type="radio" id="freteGratis" name="metodoEnvio" value="gratis"
                                    class="form-check-input" (change)="atualizarFrete('gratis')">
                                Frete Gr√°tis
                            </label>
                            <strong>R$ 0.00</strong>
                        </div>
                    </div>
                </div>

                <!-- M√©todos de envio -->
                <div *ngIf="!exibirEntrega" class="alert alert-light text-muted mt-3" role="alert">
                    Preencha seu endere√ßo de entrega para visualizar m√©todos de entrega.
                </div>

                <!-- Pagamento -->
                <h5 class="text-uppercase text-primary mb-4 mt-2">Pagamento</h5>

                <button type="submit" class="btn btn-primary w-100 rounded-3 shadow-sm"
                    [disabled]="!isFormularioValido(checkoutForm) || loadingPagamento">
                    <span *ngIf="!loadingPagamento">üîí Finalizar compra</span>
                    <span *ngIf="loadingPagamento">
                        <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                        Processando...
                    </span>
                </button>
            </form>
        </div>

        <!-- Coluna Direita: Resumo -->
        <div class="col-md-5" *ngIf="cartItems.length > 0;">
            <div class="card shadow-sm rounded-3">
                <div class="card-body">
                    <div *ngFor="let item of cartItems" class="mb-4 border-bottom pb-3">
                        <div class="d-flex align-items-center mb-2">
                            <img [src]="item.products?.image_url || 'assets/default-product.png'"
                                [alt]="item.products?.name" width="60" class="me-3 rounded" />
                            <div>
                                <strong>{{ item.products?.name }}</strong><br />

                                <!-- PERSONALIZA√á√ÉO -->
                                {{ item.size }} /
                                <span *ngIf="item.personalizar; else naoPersonalizado" class="text-success fw-bold">
                                    Blusa Personalizada ‚úÖ
                                </span>
                                <ng-template #naoPersonalizado>N√£o Personalizar</ng-template>

                                <!-- VALOR -->
                                <div class="text-success fw-bold">
                                    R$ {{ item.preco_final | number:'1.2-2' }}
                                </div>
                            </div>
                        </div>
                        <p>Quantidade: {{ item.quantity }}</p>
                    </div>

                    <!-- RESUMO FINAL -->
                    <div class="pt-3">
                        <p class="mb-1">Subtotal: <strong>R$ {{ getSubtotal() | number:'1.2-2' }}</strong></p>
                        <p class="mb-1">Entrega: R$ {{ valorEntrega | number:'1.2-2' }}</p>

                        <h5 class="mt-3 text-success" *ngIf="pagamento.parcelasCartao; else vista">
                            Total: <strong>
                                {{ pagamento.parcelasCartao }}x de
                                R$ {{
                                (getTotal() / pagamento.parcelasCartao) | number:'1.2-2'
                                }}
                            </strong><br />
                            <small class="text-muted">
                                ou R$ {{ getTotal() | number:'1.2-2' }} √† vista
                            </small>
                        </h5>

                        <ng-template #vista>
                            <h5 class="mt-3 text-success">
                                Total: <strong>6x de R$ {{ (getTotal() / 6) | number:'1.2-2' }}</strong><br />
                                <small class="text-muted">ou R$ {{ getTotal() | number:'1.2-2' }} √† vista</small>
                            </h5>
                        </ng-template>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>