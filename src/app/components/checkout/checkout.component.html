<div class="container my-5">
    <div class="row">
        <!-- Coluna Esquerda: Formulário -->
        <div class="col-md-7">
            <div class="mb-4 text-center">
                <img src="assets/tito_logo.png" alt="Logo Soft" width="150" class="rounded" />
            </div>

            <!-- Contato -->
            <h5 class="text-uppercase text-primary mb-4">Contato</h5>
            <form #checkoutForm="ngForm" (ngSubmit)="finalizarCompra(checkoutForm)">
                <div class="mb-3">
                    <input type="email" class="form-control rounded-3 shadow-sm" placeholder="E-mail*" required
                        name="email" [(ngModel)]="cliente.email" #email="ngModel" />
                    <div *ngIf="email.invalid && email.touched" class="text-danger small">
                        Informe um email válido.
                    </div>
                </div>
                <div class="mb-3">
                    <input type="text" class="form-control rounded-3 shadow-sm" placeholder="Nome completo*" required
                        name="nome" [(ngModel)]="cliente.nome" #nome="ngModel" />
                    <div *ngIf="nome.invalid && nome.touched" class="text-danger small">
                        Informe seu nome completo.
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <input type="text" class="form-control rounded-3 shadow-sm" placeholder="Celular*" required
                            name="celular" [(ngModel)]="cliente.celular" #celular="ngModel" />
                        <div *ngIf="celular.invalid && celular.touched" class="text-danger small">
                            Informe seu celular.
                        </div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <input type="text" class="form-control rounded-3 shadow-sm" placeholder="CPF*" required
                            name="cpf" [(ngModel)]="cliente.cpf" #cpf="ngModel" />
                        <div *ngIf="cpf.invalid && cpf.touched" class="text-danger small">
                            Informe seu CPF.
                        </div>
                    </div>
                </div>

                <!-- Endereço -->
                <div class="mb-3">
                    <label for="cep" class="form-label">CEP*</label>
                    <input type="text" id="cep" class="form-control" placeholder="Digite seu CEP" required name="cep"
                        [(ngModel)]="cep" (blur)="buscarEnderecoPorCep()" #cepModel="ngModel" />
                    <div *ngIf="cepModel.invalid && cepModel.touched" class="text-danger small">
                        Informe um CEP válido.
                    </div>
                </div>

                <!-- ERRO -->
                <div *ngIf="mensagemErroCep" class="alert alert-danger">
                    {{ mensagemErroCep }}
                </div>

                <!-- BLOCO DE ENTREGA SOMENTE SE CEP FOI ENCONTRADO -->
                <div *ngIf="exibirEntrega">
                    <p><strong>{{ cep }}</strong> - {{ endereco.cidade }}/{{ endereco.estado }}</p>

                    <div class="mb-3">
                        <label class="form-label">Endereço*</label>
                        <input class="form-control" [value]="endereco.rua" readonly />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Número*</label>
                        <input class="form-control" required name="numero" [(ngModel)]="endereco.numero"
                            #numero="ngModel" />
                        <div *ngIf="numero.invalid && numero.touched" class="text-danger small">
                            Informe o número.
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Bairro*</label>
                        <input class="form-control" [value]="endereco.bairro" readonly />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Complemento</label>
                        <input class="form-control" name="complemento" [(ngModel)]="endereco.complemento" />
                    </div>

                    <!-- Método de envio -->
                    <h5>Método de envio</h5>
                    <div class="border p-3 rounded bg-light">
                        <div class="d-flex justify-content-between">
                            <label for="freteGratis" class="form-check-label">
                                <input type="radio" id="freteGratis" name="metodoEnvio" value="gratis"
                                    class="form-check-input" (change)="atualizarFrete('gratis')">
                                Frete Grátis
                            </label>
                            <strong>R$ 0.00</strong>
                        </div>
                    </div>

                </div>

                <!-- Métodos de envio -->
                <div *ngIf="!exibirEntrega" class="alert alert-light text-muted mt-3" role="alert">
                    Preencha seu endereço de entrega para visualizar métodos de entrega.
                </div>

                <!-- Pagamento -->
                <h5 class="text-uppercase text-primary mb-4 mt-2">Pagamento</h5>
                <div class="accordion" id="paymentMethods">
                    <!-- Cartão -->
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="headingCard">
                            <button class="accordion-button shadow-sm rounded-3" type="button" data-bs-toggle="collapse"
                                data-bs-target="#collapseCard" aria-expanded="true">
                                Cartão de Crédito
                            </button>
                        </h2>
                        <div id="collapseCard" class="accordion-collapse collapse show">
                            <div class="accordion-body">
                                <div class="mb-2">
                                    <input type="text" class="form-control rounded-3 shadow-sm"
                                        placeholder="Número do cartão" required name="numeroCartao"
                                        [(ngModel)]="pagamento.numeroCartao" #numeroCartao="ngModel" />
                                    <div *ngIf="numeroCartao.invalid && numeroCartao.touched" class="text-danger small">
                                        Informe o número do cartão.
                                    </div>
                                </div>
                                <div class="mb-2">
                                    <input type="text" class="form-control rounded-3 shadow-sm"
                                        placeholder="Nome impresso no cartão" required name="nomeCartao"
                                        [(ngModel)]="pagamento.nomeCartao" #nomeCartao="ngModel" />
                                    <div *ngIf="nomeCartao.invalid && nomeCartao.touched" class="text-danger small">
                                        Informe o nome do cartão.
                                    </div>
                                </div>
                                <div class="row mb-2">
                                    <div class="col-md-6">
                                        <input type="text" class="form-control rounded-3 shadow-sm" placeholder="MM/AA"
                                            required name="validadeCartao" [(ngModel)]="pagamento.validadeCartao"
                                            #validadeCartao="ngModel" />
                                        <div *ngIf="validadeCartao.invalid && validadeCartao.touched"
                                            class="text-danger small">
                                            Informe a validade.
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <input type="text" class="form-control rounded-3 shadow-sm" placeholder="CVV"
                                            required name="cvvCartao" [(ngModel)]="pagamento.cvvCartao"
                                            #cvvCartao="ngModel" />
                                        <div *ngIf="cvvCartao.invalid && cvvCartao.touched" class="text-danger small">
                                            Informe o CVV.
                                        </div>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <select class="form-select rounded-3 shadow-sm" required name="parcelasCartao"
                                        [(ngModel)]="pagamento.parcelasCartao" #parcelasCartao="ngModel">
                                        <option value="" disabled selected>Selecione a parcela</option>
                                        <option *ngFor="let p of parcelasDisponiveis" [value]="p.parcelas">
                                            {{ p.parcelas }}x de R$ {{ p.valorParcela | number:'1.2-2' }}
                                        </option>
                                    </select>
                                    <div *ngIf="parcelasCartao.invalid && parcelasCartao.touched"
                                        class="text-danger small">
                                        Selecione a quantidade de parcelas.
                                    </div>
                                </div>
                                <div class="form-check mb-3">
                                    <input type="checkbox" class="form-check-input" id="saveCardInfo"
                                        name="saveCardInfo" [(ngModel)]="pagamento.salvarInfo" />
                                    <label class="form-check-label" for="saveCardInfo">
                                        Salvar minhas informações com segurança
                                    </label>
                                </div>
                                <button type="submit" class="btn btn-primary w-100 rounded-3 shadow-sm"
                                    [disabled]="checkoutForm.invalid">
                                    🔒 Finalizar compra
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- PIX -->
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="headingPix">
                            <button class="accordion-button collapsed shadow-sm rounded-3" type="button"
                                data-bs-toggle="collapse" data-bs-target="#collapsePix" aria-expanded="false">
                                PIX
                            </button>
                        </h2>
                        <div id="collapsePix" class="accordion-collapse collapse" data-bs-parent="#paymentMethods">
                            <div class="accordion-body">
                                <p><strong>Clique em "Finalizar Compra" para gerar o PIX.</strong></p>
                                <ul>
                                    <li>Valor à vista <strong>R$ {{ getTotal() | number:'1.2-2' }}</strong>;</li>
                                    <li>Não pode ser parcelado! Use cartão de crédito para parcelar sua compra;</li>
                                    <li>Prazo de até 30 minutos para compensar.</li>
                                </ul>
                                <button type="submit" class="btn btn-primary w-100 rounded-3 shadow-sm"
                                    [disabled]="checkoutForm.invalid">
                                    🔒 Finalizar compra
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- BOLETO -->
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="headingBoleto">
                            <button class="accordion-button collapsed shadow-sm rounded-3" type="button"
                                data-bs-toggle="collapse" data-bs-target="#collapseBoleto" aria-expanded="false">
                                Boleto
                            </button>
                        </h2>
                        <div id="collapseBoleto" class="accordion-collapse collapse" data-bs-parent="#paymentMethods">
                            <div class="accordion-body">
                                <p><strong>Clique em "Finalizar Compra" para gerar o Boleto.</strong></p>
                                <ul>
                                    <li>Valor à vista <strong>R$ {{ getTotal() | number:'1.2-2' }}</strong>;</li>
                                    <li>Não pode ser parcelado! Use cartão de crédito para parcelar sua compra;</li>
                                    <li>Prazo de até 3 dias úteis para compensar.</li>
                                </ul>
                                <button type="submit" class="btn btn-primary w-100 rounded-3 shadow-sm"
                                    [disabled]="checkoutForm.invalid">
                                    🔒 Finalizar compra
                                </button>
                            </div>
                        </div>
                    </div>

                </div>
            </form>
        </div>

        <!-- Coluna Direita: Resumo -->
        <div class="col-md-5" *ngIf="cartItems.length > 0;">
            <div class="card shadow-sm rounded-3">
                <div class="card-body">
                    <div *ngFor="let item of cartItems" class="mb-4 border-bottom pb-3">
                        <div class="d-flex align-items-center mb-2">
                            <img [src]="item.products?.image_url || 'assets/default-product.png'"
                                [alt]="item.products?.name" width="60" class="me-3 rounded" />
                            <div>
                                <strong>{{ item.products?.name }}</strong><br />

                                <!-- PERSONALIZAÇÃO -->
                                {{ item.size }} /
                                <span *ngIf="item.personalizar; else naoPersonalizado" class="text-success fw-bold">
                                    Blusa Personalizada ✅
                                </span>
                                <ng-template #naoPersonalizado>Não Personalizar</ng-template>

                                <!-- VALOR -->
                                <div class="text-success fw-bold">
                                    R$ {{ item.preco_final | number:'1.2-2' }}
                                </div>
                            </div>
                        </div>
                        <p>Quantidade: {{ item.quantity }}</p>
                    </div>

                    <!-- RESUMO FINAL -->
                    <div class="pt-3">
                        <p class="mb-1">Subtotal: <strong>R$ {{ getSubtotal() | number:'1.2-2' }}</strong></p>
                        <p class="mb-1">Entrega: R$ {{ valorEntrega | number:'1.2-2' }}</p>

                        <h5 class="mt-3 text-success" *ngIf="pagamento.parcelasCartao; else vista">
                            Total: <strong>
                                {{ pagamento.parcelasCartao }}x de
                                R$ {{
                                (getTotal() / pagamento.parcelasCartao) | number:'1.2-2'
                                }}
                            </strong><br />
                            <small class="text-muted">
                                ou R$ {{ getTotal() | number:'1.2-2' }} à vista
                            </small>
                        </h5>

                        <ng-template #vista>
                            <h5 class="mt-3 text-success">
                                Total: <strong>6x de R$ {{ (getTotal() / 6) | number:'1.2-2' }}</strong><br />
                                <small class="text-muted">ou R$ {{ getTotal() | number:'1.2-2' }} à vista</small>
                            </h5>
                        </ng-template>
                    </div>
                </div>
            </div>
        </div>


    </div>
</div>